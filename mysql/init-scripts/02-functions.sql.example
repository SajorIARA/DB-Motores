-- ====================================================================================
-- FUNCIONES Y STORED PROCEDURES
-- ====================================================================================

USE `${MYSQL_DATABASE}`;

DELIMITER $$

-- ====================================================================================
-- FUNCIÓN: Contar posts por usuario
-- ====================================================================================

CREATE FUNCTION IF NOT EXISTS count_user_posts(user_id_param INT)
RETURNS INT
READS SQL DATA
BEGIN
    DECLARE post_count INT;
    SELECT COUNT(*) INTO post_count FROM posts WHERE user_id = user_id_param;
    RETURN post_count;
END$$

-- ====================================================================================
-- STORED PROCEDURE: Obtener posts con estadísticas
-- ====================================================================================

CREATE PROCEDURE IF NOT EXISTS get_posts_with_stats()
BEGIN
    SELECT 
        p.id,
        p.title,
        u.username AS author,
        p.status,
        p.views,
        COUNT(DISTINCT c.id) AS comment_count,
        p.created_at,
        p.published_at
    FROM posts p
    LEFT JOIN users u ON p.user_id = u.id
    LEFT JOIN comments c ON p.id = c.post_id AND c.status = 'approved'
    GROUP BY p.id
    ORDER BY p.created_at DESC;
END$$

-- ====================================================================================
-- STORED PROCEDURE: Limpiar posts antiguos
-- ====================================================================================

CREATE PROCEDURE IF NOT EXISTS cleanup_old_drafts(days_old INT)
BEGIN
    DELETE FROM posts 
    WHERE status = 'draft' 
    AND DATEDIFF(NOW(), created_at) > days_old;
    
    SELECT ROW_COUNT() AS deleted_count;
END$$

-- ====================================================================================
-- TRIGGER: Actualizar contador de vistas
-- ====================================================================================

CREATE TRIGGER IF NOT EXISTS before_post_update
BEFORE UPDATE ON posts
FOR EACH ROW
BEGIN
    IF NEW.status = 'published' AND OLD.status != 'published' THEN
        SET NEW.published_at = NOW();
    END IF;
END$$

DELIMITER ;

-- ====================================================================================
-- VERIFICACIÓN
-- ====================================================================================

SELECT 'Functions and procedures created successfully!' AS Status;
