-- =====================================================
-- Funciones y Triggers - Ejemplo
-- =====================================================

-- Función para actualizar timestamp automáticamente
CREATE OR REPLACE FUNCTION app.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger para users
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON app.users
    FOR EACH ROW
    EXECUTE FUNCTION app.update_updated_at_column();

-- Trigger para posts
CREATE TRIGGER update_posts_updated_at
    BEFORE UPDATE ON app.posts
    FOR EACH ROW
    EXECUTE FUNCTION app.update_updated_at_column();

-- Función de ejemplo: buscar usuarios por texto
CREATE OR REPLACE FUNCTION app.search_users(search_term TEXT)
RETURNS TABLE (
    id UUID,
    username VARCHAR(50),
    email VARCHAR(100),
    full_name VARCHAR(100)
) AS $$
BEGIN
    RETURN QUERY
    SELECT u.id, u.username, u.email, u.full_name
    FROM app.users u
    WHERE 
        u.username ILIKE '%' || search_term || '%'
        OR u.email ILIKE '%' || search_term || '%'
        OR u.full_name ILIKE '%' || search_term || '%';
END;
$$ LANGUAGE plpgsql;

-- Mensaje de confirmación
DO $$
BEGIN
    RAISE NOTICE '✅ Funciones y triggers creados';
END $$;
