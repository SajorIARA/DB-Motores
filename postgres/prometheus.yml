# ====================================================================================
# CONFIGURACIÓN DE PROMETHEUS PARA POSTGRESQL MONITORING
# ====================================================================================
# Este archivo define cómo Prometheus recolecta métricas del postgres_exporter
# ====================================================================================

global:
  # Intervalo de scraping por defecto (cada cuánto recolecta métricas)
  scrape_interval: 15s
  
  # Timeout para cada scrape
  scrape_timeout: 10s
  
  # Intervalo de evaluación de reglas
  evaluation_interval: 15s
  
  # Labels externos que se añaden a todas las métricas
  external_labels:
    monitor: 'postgres-monitor'
    environment: 'development'

# ====================================================================================
# JOBS DE SCRAPING - Define qué endpoints monitorear
# ====================================================================================
scrape_configs:
  
  # ==================================================================================
  # 1. PROMETHEUS SELF-MONITORING
  # ==================================================================================
  # Monitorea el propio Prometheus
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'prometheus-server'
          service: 'prometheus'
    # Métricas cada 30 segundos (menos frecuente)
    scrape_interval: 30s

  # ==================================================================================
  # 2. POSTGRESQL EXPORTER - MÉTRICAS DE BASE DE DATOS
  # ==================================================================================
  # Monitorea PostgreSQL a través del postgres_exporter
  - job_name: 'postgresql'
    static_configs:
      - targets: ['postgres-exporter:9187']
        labels:
          instance: 'postgres-test'
          service: 'postgresql'
          database: 'test_db'
          version: '17'
    
    # Scrape cada 10 segundos (alta frecuencia para bases de datos)
    scrape_interval: 10s
    scrape_timeout: 8s
    
    # Configuración específica para PostgreSQL
    metric_relabel_configs:
      # Eliminar métricas muy detalladas que no necesitamos (opcional)
      # - source_labels: [__name__]
      #   regex: 'pg_stat_activity_.*'
      #   action: drop
      
      # Renombrar labels si es necesario (ejemplo)
      - source_labels: [datname]
        target_label: database_name
        action: replace
      
      - source_labels: [usename]
        target_label: username
        action: replace

# ====================================================================================
# REGLAS DE ALERTAS (OPCIONAL)
# ====================================================================================
# Descomentar para cargar reglas de alertas desde archivos externos
# rule_files:
#   - "/etc/prometheus/rules/*.yml"

# ====================================================================================
# CONFIGURACIÓN DE ALERTMANAGER (OPCIONAL)
# ====================================================================================
# Descomentar si vas a usar Alertmanager para notificaciones
# alerting:
#   alertmanagers:
#     - static_configs:
#         - targets:
#           - 'alertmanager:9093'

# ====================================================================================
# REMOTE WRITE (OPCIONAL)
# ====================================================================================
# Para enviar métricas a servicios externos como Grafana Cloud, Thanos, etc.
# remote_write:
#   - url: 'https://prometheus-remote-write-endpoint.example.com/api/v1/write'
#     basic_auth:
#       username: 'user'
#       password: 'password'

# ====================================================================================
# NOTAS IMPORTANTES
# ====================================================================================
# - Los targets usan nombres de servicios de Docker (postgres-exporter, no localhost)
# - scrape_interval de 10s es bueno para producción, usar 5s solo para debug
# - Las métricas custom de postgres-queries.yaml se recolectan automáticamente
# - Para ver targets: http://localhost:9090/targets
# - Para ver configuración: http://localhost:9090/config
# - Para recargar config sin reiniciar: curl -X POST http://localhost:9090/-/reload
# ====================================================================================
